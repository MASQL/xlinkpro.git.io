<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>X-Link Pro v7.1 | WA Style</title>
    <style>
        :root { --primary: #00ff88; --danger: #ff4444; --overlay: rgba(0,0,0,0.6); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: white; overflow: hidden; }

        /* UI Container */
        .app-container { position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; }

        /* Fullscreen Video (Lawan Bicara) */
        .remote-viewport { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background: #111; }
        .remote-viewport video { width: 100%; height: 100%; object-fit: cover; }

        /* Floating Local Video (Diri Sendiri) */
        .local-pip { position: absolute; top: 20px; right: 20px; width: 110px; height: 160px; border-radius: 12px; overflow: hidden; z-index: 10; border: 1px solid rgba(255,255,255,0.3); box-shadow: 0 8px 16px rgba(0,0,0,0.5); background: #000; }
        .local-pip video { width: 100%; height: 100%; object-fit: cover; }
        .mirrored { transform: scaleX(-1); }

        /* Overlay Info & Controls */
        .top-info { position: absolute; top: 30px; left: 20px; z-index: 5; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        .status-badge { background: var(--overlay); padding: 5px 12px; border-radius: 20px; font-size: 12px; border: 1px solid var(--primary); color: var(--primary); }

        .bottom-controls { position: absolute; bottom: 40px; left: 0; width: 100%; z-index: 5; display: flex; justify-content: center; gap: 20px; padding: 0 20px; }
        
        .btn-circle { width: 60px; height: 60px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; background: var(--overlay); color: white; backdrop-filter: blur(5px); font-size: 20px; }
        .btn-danger { background: var(--danger); }
        .btn-active { background: var(--primary); color: black; }

        /* Setup Screen */
        #setup-screen { position: absolute; inset: 0; z-index: 20; background: #0a0a0a; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; text-align: center; }
        .id-box { background: #1a1a1a; padding: 20px; border-radius: 20px; width: 100%; max-width: 300px; margin-bottom: 20px; border: 1px dashed var(--primary); }
        input { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #333; background: #000; color: white; text-align: center; margin-bottom: 15px; font-size: 16px; }
        .main-btn { width: 100%; max-width: 300px; padding: 18px; border-radius: 15px; border: none; font-weight: bold; cursor: pointer; background: var(--primary); color: #000; margin-top: 10px; }
        
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="app-container">
    <div id="setup-screen">
        <h2 style="margin-bottom: 5px;">X-LINK <span style="color:var(--primary)">PRO v7.1</span></h2>
        <p style="color: #888; font-size: 14px; margin-bottom: 30px;">Secure P2P Video Call</p>
        
        <div class="id-box">
            <small style="color: #888;">ID PERANGKAT ANDA</small>
            <div id="myId" style="font-size: 22px; font-weight: bold; color: var(--primary); margin-top: 5px;">Memuat ID...</div>
        </div>

        <input type="text" id="targetId" placeholder="Masukkan ID Tujuan">
        <button class="main-btn" onclick="startCall('join')">MULAI PANGGILAN</button>
        <button class="main-btn" style="background:#222; color:white" onclick="startCall('monitor')">SIAGA (MODE MONITOR)</button>
    </div>

    <div id="call-screen" class="hidden">
        <div class="top-info">
            <div id="callStatus" class="status-badge">Menghubungkan...</div>
        </div>

        <div class="local-pip" id="pip-container">
            <video id="localVideo" class="mirrored" autoplay playsinline muted></video>
        </div>

        <div class="remote-viewport">
            <video id="remoteVideo" autoplay playsinline></video>
        </div>

        <div class="bottom-controls">
            <button class="btn-circle" id="btn-flash" onclick="toggleFlash()">ðŸ”¦</button>
            <button class="btn-circle" onclick="switchCamera()">ðŸ”„</button>
            <button class="btn-circle" onclick="toggleAudio()" id="btn-mic">ðŸŽ¤</button>
            <button class="btn-circle btn-danger" onclick="endCall()">ðŸ“ž</button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
    const peer = new Peer();
    let localStream, dataConn, currentCall;
    let isFlash = false, isMic = true, facing = "user";

    peer.on('open', id => { document.getElementById('myId').innerText = id; });

    // Handle incoming call
    peer.on('call', async (call) => {
        showCallUI();
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById('localVideo').srcObject = localStream;
        
        call.answer(localStream);
        handleCall(call);
    });

    async function startCall(mode) {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: facing }, 
                audio: true 
            });
            document.getElementById('localVideo').srcObject = localStream;

            if (mode === 'join') {
                const tid = document.getElementById('targetId').value;
                if (!tid) return alert("Masukkan ID tujuan!");
                
                showCallUI();
                const call = peer.call(tid, localStream);
                handleCall(call);
            } else {
                showCallUI();
                document.getElementById('callStatus').innerText = "Mode Siaga (Menunggu Panggilan)";
            }
        } catch (err) {
            alert("Izin Kamera/Mic Ditolak: " + err);
        }
    }

    function handleCall(call) {
        currentCall = call;
        call.on('stream', remoteStream => {
            document.getElementById('remoteVideo').srcObject = remoteStream;
            document.getElementById('callStatus').innerText = "Enkripsi P2P Aktif";
        });
        call.on('close', endCall);
    }

    function showCallUI() {
        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('call-screen').classList.remove('hidden');
    }

    function toggleAudio() {
        isMic = !isMic;
        localStream.getAudioTracks()[0].enabled = isMic;
        document.getElementById('btn-mic').classList.toggle('btn-active', !isMic);
        document.getElementById('btn-mic').innerText = isMic ? "ðŸŽ¤" : "ðŸ”‡";
    }

    async function switchCamera() {
        facing = (facing === "user") ? "environment" : "user";
        const videoTrack = localStream.getVideoTracks()[0];
        videoTrack.stop();

        const newStream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: facing } 
        });
        const newVideoTrack = newStream.getVideoTracks()[0];
        localStream.removeTrack(videoTrack);
        localStream.addTrack(newVideoTrack);

        document.getElementById('localVideo').classList.toggle('mirrored', facing === "user");
        
        // Re-negotiate stream if call is active
        if (currentCall) {
            const sender = currentCall.peerConnection.getSenders().find(s => s.track.kind === 'video');
            sender.replaceTrack(newVideoTrack);
        }
    }

    async function toggleFlash() {
        const track = localStream.getVideoTracks()[0];
        try {
            isFlash = !isFlash;
            await track.applyConstraints({ advanced: [{ torch: isFlash }] });
            document.getElementById('btn-flash').classList.toggle('btn-active', isFlash);
        } catch (e) { alert("Flash tidak tersedia di kamera ini"); }
    }

    function endCall() {
        location.reload();
    }
</script>
</body>
</html>
